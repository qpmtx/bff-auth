name: "ğŸš€ Release & Publish"

on:
  push:
    branches: [main]
    paths-ignore:
      - CHANGELOG.md

# Minimal global permissions; job-level permissions are set where needed
permissions:
  contents: write
  pull-requests: read

env:
  NODE_VERSION: "20"

jobs:
  check-pr-merge:
    name: "ğŸ” Check PR Merge"
    runs-on: ubuntu-latest

    outputs:
      is-pr-merge: ${{ steps.check.outputs.is-pr-merge }}
      pr-title: ${{ steps.check.outputs.pr-title }}
      pr-labels: ${{ steps.check.outputs.pr-labels }}
      version-type: ${{ steps.version-type.outputs.type }}

    steps:
      - name: "ğŸ” Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ” Check if push is from merged PR"
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          if [[ "$COMMIT_MSG" == *"Merge pull request"* ]] || [[ "$COMMIT_MSG" == *"#"* ]]; then
            echo "is-pr-merge=true" >> "$GITHUB_OUTPUT"
            PR_NUM=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
            echo "PR Number: $PR_NUM"

            if [ -n "$PR_NUM" ]; then
              PR_DATA=$(gh pr view "$PR_NUM" --json title,labels --jq '{title: .title, labels: [.labels[].name]}')
              echo "pr-title=$(echo "$PR_DATA" | jq -r '.title')"  >> "$GITHUB_OUTPUT"
              echo "pr-labels=$(echo "$PR_DATA" | jq -r '.labels | join(",")')" >> "$GITHUB_OUTPUT"
            else
              echo "pr-title=$COMMIT_MSG" >> "$GITHUB_OUTPUT"
              echo "pr-labels="          >> "$GITHUB_OUTPUT"
            fi
          else
            echo "is-pr-merge=false" >> "$GITHUB_OUTPUT"
          fi

      - name: "ğŸ·ï¸ Determine version bump type"
        id: version-type
        run: |
          PR_TITLE="${{ steps.check.outputs.pr-title }}"
          PR_LABELS="${{ steps.check.outputs.pr-labels }}"
          VERSION_TYPE="patch"

          if   [[ "$PR_LABELS" == *"major"* ]]   || [[ "$PR_LABELS" == *"breaking"* ]]; then VERSION_TYPE="major"
          elif [[ "$PR_LABELS" == *"minor"* ]]   || [[ "$PR_LABELS" == *"feature"*  ]]; then VERSION_TYPE="minor"
          elif [[ "$PR_LABELS" == *"patch"* ]]   || [[ "$PR_LABELS" == *"fix"*     ]]; then VERSION_TYPE="patch"
          elif [[ "$PR_TITLE"  == *"BREAKING"* ]]|| [[ "$PR_TITLE"  == *"!"*       ]]; then VERSION_TYPE="major"
          elif [[ "$PR_TITLE"  == feat* ]]       || [[ "$PR_TITLE"  == "âœ¨"*       ]]; then VERSION_TYPE="minor"
          elif [[ "$PR_TITLE"  == fix*  ]]       || [[ "$PR_TITLE"  == "ğŸ›"*       ]]; then VERSION_TYPE="patch"
          fi

          echo "type=$VERSION_TYPE" >> "$GITHUB_OUTPUT"

  release:
    name: "ğŸš€ Release & Publish to npm"
    runs-on: ubuntu-latest
    needs: check-pr-merge
    if: needs.check-pr-merge.outputs.is-pr-merge == 'true'

    # Required for OIDC (Trusted Publishing) + creating GitHub releases
    permissions:
      contents: write
      id-token: write

    steps:
      - name: "ğŸ” Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ“¦ Setup pnpm"
        uses: pnpm/action-setup@v2
        with:
          version: 10.13.1

      - name: "ğŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org

      # npm 11.5.1+ is required for trusted publishing & automatic provenance
      - name: "â¬†ï¸ Ensure recent npm"
        run: npm install -g npm@latest

      - name: "ğŸ“¥ Install dependencies"
        run: pnpm install --no-frozen-lockfile

      - name: "ğŸ§ª Test & build"
        run: |
          pnpm test
          pnpm build

      - name: "ğŸ”§ Configure Git"
        run: |
          git config --local user.email "qpmtx@qpmatrix.com"
          git config --local user.name  "QPMTX Action"

      - name: "ğŸ“ˆ Get current version"
        id: current-version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: "ğŸ·ï¸ Bump version"
        id: bump-version
        run: |
          VERSION_TYPE="${{ needs.check-pr-merge.outputs.version-type }}"
          NEW_VERSION=$(npm version "$VERSION_TYPE" --no-git-tag-version)
          echo "new=${NEW_VERSION#v}" >> "$GITHUB_OUTPUT"

      # Make sure the first publish of a scoped package is public
      - name: "ğŸ“ Ensure public access for scoped package"
        run: |
          node <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.publishConfig = { ...(pkg.publishConfig ?? {}), access: 'public' };
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          NODE

      - name: "ğŸ—ï¸ Build package (post-bump)"
        run: pnpm build

      - name: "ğŸ“„ Generate changelog entry"
        id: changelog
        env:
          PR_TITLE: ${{ needs.check-pr-merge.outputs.pr-title }}
          VERSION_TYPE: ${{ needs.check-pr-merge.outputs.version-type }}
        run: |
          cat > entry.md <<EOF
          - ${PR_TITLE}
          EOF

          if [ -f CHANGELOG.md ]; then
            awk 'NR==1 {print; print ""; while(getline < "entry.md") print; next}1' CHANGELOG.md > tmp && mv tmp CHANGELOG.md
          else
            printf "# Changelog\n\n" > CHANGELOG.md
            cat entry.md >> CHANGELOG.md
          fi

      - name: "ğŸ’¾ Commit version & changelog"
        run: |
          NEW_VERSION="${{ steps.bump-version.outputs.new }}"
          git add package.json CHANGELOG.md
          git commit -m "chore(release): v${NEW_VERSION} [skip ci]"

      - name: "ğŸ·ï¸ Create tag"
        id: create-tag
        run: |
          NEW_VERSION="${{ steps.bump-version.outputs.new }}"
          TAG="qpmtx-bff-auth-v${NEW_VERSION}"
          git tag -a "$TAG" -m "Release $TAG"
          echo "tag-name=$TAG" >> "$GITHUB_OUTPUT"

      - name: "ğŸ“¤ Push changes & tags"
        run: git push --follow-tags origin main

      # ğŸ‘‰ Trusted Publishing: no NPM_TOKEN required; OIDC is used automatically.
      # First scoped publish must be public; subsequent runs are fine too.
      - name: "ğŸ“¦ Publish to npm (trusted publishing)"
        run: npm publish --access public

      - name: "ğŸ“‹ Create GitHub Release"
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.create-tag.outputs.tag-name }}
          release_name: "ğŸš€ Release v${{ steps.bump-version.outputs.new }}"
          body: |
            ## Whatâ€™s New
            - ${{ needs.check-pr-merge.outputs.pr-title }}
          draft: false
          prerelease: false

      - name: "ğŸ“Š Summary"
        run: |
          echo "### âœ… Released v${{ steps.bump-version.outputs.new }} to npm" >> "$GITHUB_STEP_SUMMARY"
